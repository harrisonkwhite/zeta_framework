#include <zcl/zcl_mem.h>

#include <cstring>

namespace zf {
    void s_mem_arena::Release() {
        const auto f = [](const auto self, const s_ptr<s_block> block) {
            if (!block) {
                return;
            }

            self(self, block->next);

            free(block->buf);
            free(block);
        };

        f(f, m_blocks_head);

        *this = {};
    }

    s_ptr<void> s_mem_arena::Push(const t_i32 size, const t_i32 alignment) {
        ZF_ASSERT(size > 0 && IsAlignmentValid(alignment));

        if (!m_blocks_head) {
            m_blocks_head = CreateBlock(ZF_MAX(size, m_block_min_buf_size));
            m_block_cur = m_blocks_head;
            return Push(size, alignment);
        }

        const t_i32 offs_aligned = AlignForward(m_block_cur_offs, alignment);
        const t_i32 offs_next = offs_aligned + size;

        if (offs_next > m_block_cur->buf_size) {
            if (!m_block_cur->next) {
                m_block_cur->next = CreateBlock(ZF_MAX(size, m_block_min_buf_size));
            }

            m_block_cur = m_block_cur->next;
            m_block_cur_offs = 0;

            return Push(size, alignment);
        }

        m_block_cur_offs = offs_next;

        return static_cast<s_ptr<t_u8>>(m_block_cur->buf) + offs_aligned;
    }

    s_ptr<s_mem_arena::s_block> s_mem_arena::CreateBlock(const t_i32 buf_size) {
        ZF_ASSERT(buf_size > 0);

        const auto res = static_cast<s_block *>(malloc(ZF_SIZE_OF(s_block)));

        if (!res) {
            ZF_FATAL();
        }

        new (res) s_block();

        res->buf = malloc(static_cast<size_t>(buf_size));
        res->buf_size = buf_size;

        if (!res->buf) {
            ZF_FATAL();
        }

        // Touch the whole block to truly reserve the memory.
        memset(res->buf, 0, static_cast<size_t>(res->buf_size));

        return res;
    }

    // ============================================================
    // @section: Bits
    // ============================================================
    static t_i32 IndexOfFirstSetBitHelper(const s_bit_vec_rdonly bv, const t_i32 from, const t_u8 xor_mask) {
        ZF_ASSERT(from >= 0 && from <= bv.BitCount()); // Intentionally allowing the upper bound here for the case of iteration.

        // Map of each possible byte to the index of the first set bit, or -1 for the first case.
        static constexpr s_static_array<t_i32, 256> g_mappings = {{
            -1, // 0000 0000
            0,  // 0000 0001
            1,  // 0000 0010
            0,  // 0000 0011
            2,  // 0000 0100
            0,  // 0000 0101
            1,  // 0000 0110
            0,  // 0000 0111
            3,  // 0000 1000
            0,  // 0000 1001
            1,  // 0000 1010
            0,  // 0000 1011
            2,  // 0000 1100
            0,  // 0000 1101
            1,  // 0000 1110
            0,  // 0000 1111
            4,  // 0001 0000
            0,  // 0001 0001
            1,  // 0001 0010
            0,  // 0001 0011
            2,  // 0001 0100
            0,  // 0001 0101
            1,  // 0001 0110
            0,  // 0001 0111
            3,  // 0001 1000
            0,  // 0001 1001
            1,  // 0001 1010
            0,  // 0001 1011
            2,  // 0001 1100
            0,  // 0001 1101
            1,  // 0001 1110
            0,  // 0001 1111
            5,  // 0010 0000
            0,  // 0010 0001
            1,  // 0010 0010
            0,  // 0010 0011
            2,  // 0010 0100
            0,  // 0010 0101
            1,  // 0010 0110
            0,  // 0010 0111
            3,  // 0010 1000
            0,  // 0010 1001
            1,  // 0010 1010
            0,  // 0010 1011
            2,  // 0010 1100
            0,  // 0010 1101
            1,  // 0010 1110
            0,  // 0010 1111
            4,  // 0011 0000
            0,  // 0011 0001
            1,  // 0011 0010
            0,  // 0011 0011
            2,  // 0011 0100
            0,  // 0011 0101
            1,  // 0011 0110
            0,  // 0011 0111
            3,  // 0011 1000
            0,  // 0011 1001
            1,  // 0011 1010
            0,  // 0011 1011
            2,  // 0011 1100
            0,  // 0011 1101
            1,  // 0011 1110
            0,  // 0011 1111
            6,  // 0100 0000
            0,  // 0100 0001
            1,  // 0100 0010
            0,  // 0100 0011
            2,  // 0100 0100
            0,  // 0100 0101
            1,  // 0100 0110
            0,  // 0100 0111
            3,  // 0100 1000
            0,  // 0100 1001
            1,  // 0100 1010
            0,  // 0100 1011
            2,  // 0100 1100
            0,  // 0100 1101
            1,  // 0100 1110
            0,  // 0100 1111
            4,  // 0101 0000
            0,  // 0101 0001
            1,  // 0101 0010
            0,  // 0101 0011
            2,  // 0101 0100
            0,  // 0101 0101
            1,  // 0101 0110
            0,  // 0101 0111
            3,  // 0101 1000
            0,  // 0101 1001
            1,  // 0101 1010
            0,  // 0101 1011
            2,  // 0101 1100
            0,  // 0101 1101
            1,  // 0101 1110
            0,  // 0101 1111
            5,  // 0110 0000
            0,  // 0110 0001
            1,  // 0110 0010
            0,  // 0110 0011
            2,  // 0110 0100
            0,  // 0110 0101
            1,  // 0110 0110
            0,  // 0110 0111
            3,  // 0110 1000
            0,  // 0110 1001
            1,  // 0110 1010
            0,  // 0110 1011
            2,  // 0110 1100
            0,  // 0110 1101
            1,  // 0110 1110
            0,  // 0110 1111
            4,  // 0111 0000
            0,  // 0111 0001
            1,  // 0111 0010
            0,  // 0111 0011
            2,  // 0111 0100
            0,  // 0111 0101
            1,  // 0111 0110
            0,  // 0111 0111
            3,  // 0111 1000
            0,  // 0111 1001
            1,  // 0111 1010
            0,  // 0111 1011
            2,  // 0111 1100
            0,  // 0111 1101
            1,  // 0111 1110
            0,  // 0111 1111
            7,  // 1000 0000
            0,  // 1000 0001
            1,  // 1000 0010
            0,  // 1000 0011
            2,  // 1000 0100
            0,  // 1000 0101
            1,  // 1000 0110
            0,  // 1000 0111
            3,  // 1000 1000
            0,  // 1000 1001
            1,  // 1000 1010
            0,  // 1000 1011
            2,  // 1000 1100
            0,  // 1000 1101
            1,  // 1000 1110
            0,  // 1000 1111
            4,  // 1001 0000
            0,  // 1001 0001
            1,  // 1001 0010
            0,  // 1001 0011
            2,  // 1001 0100
            0,  // 1001 0101
            1,  // 1001 0110
            0,  // 1001 0111
            3,  // 1001 1000
            0,  // 1001 1001
            1,  // 1001 1010
            0,  // 1001 1011
            2,  // 1001 1100
            0,  // 1001 1101
            1,  // 1001 1110
            0,  // 1001 1111
            5,  // 1010 0000
            0,  // 1010 0001
            1,  // 1010 0010
            0,  // 1010 0011
            2,  // 1010 0100
            0,  // 1010 0101
            1,  // 1010 0110
            0,  // 1010 0111
            3,  // 1010 1000
            0,  // 1010 1001
            1,  // 1010 1010
            0,  // 1010 1011
            2,  // 1010 1100
            0,  // 1010 1101
            1,  // 1010 1110
            0,  // 1010 1111
            4,  // 1011 0000
            0,  // 1011 0001
            1,  // 1011 0010
            0,  // 1011 0011
            2,  // 1011 0100
            0,  // 1011 0101
            1,  // 1011 0110
            0,  // 1011 0111
            3,  // 1011 1000
            0,  // 1011 1001
            1,  // 1011 1010
            0,  // 1011 1011
            2,  // 1011 1100
            0,  // 1011 1101
            1,  // 1011 1110
            0,  // 1011 1111
            6,  // 1100 0000
            0,  // 1100 0001
            1,  // 1100 0010
            0,  // 1100 0011
            2,  // 1100 0100
            0,  // 1100 0101
            1,  // 1100 0110
            0,  // 1100 0111
            3,  // 1100 1000
            0,  // 1100 1001
            1,  // 1100 1010
            0,  // 1100 1011
            2,  // 1100 1100
            0,  // 1100 1101
            1,  // 1100 1110
            0,  // 1100 1111
            4,  // 1101 0000
            0,  // 1101 0001
            1,  // 1101 0010
            0,  // 1101 0011
            2,  // 1101 0100
            0,  // 1101 0101
            1,  // 1101 0110
            0,  // 1101 0111
            3,  // 1101 1000
            0,  // 1101 1001
            1,  // 1101 1010
            0,  // 1101 1011
            2,  // 1101 1100
            0,  // 1101 1101
            1,  // 1101 1110
            0,  // 1101 1111
            5,  // 1110 0000
            0,  // 1110 0001
            1,  // 1110 0010
            0,  // 1110 0011
            2,  // 1110 0100
            0,  // 1110 0101
            1,  // 1110 0110
            0,  // 1110 0111
            3,  // 1110 1000
            0,  // 1110 1001
            1,  // 1110 1010
            0,  // 1110 1011
            2,  // 1110 1100
            0,  // 1110 1101
            1,  // 1110 1110
            0,  // 1110 1111
            4,  // 1111 0000
            0,  // 1111 0001
            1,  // 1111 0010
            0,  // 1111 0011
            2,  // 1111 0100
            0,  // 1111 0101
            1,  // 1111 0110
            0,  // 1111 0111
            3,  // 1111 1000
            0,  // 1111 1001
            1,  // 1111 1010
            0,  // 1111 1011
            2,  // 1111 1100
            0,  // 1111 1101
            1,  // 1111 1110
            0,  // 1111 1111
        }};

        const t_i32 begin_byte_index = from / 8;

        for (t_i32 i = begin_byte_index; i < bv.Bytes().Len(); i++) {
            t_u8 byte = bv.Bytes()[i] ^ xor_mask;

            if (i == begin_byte_index) {
                byte &= BitmaskRange(from % 8);
            }

            if (i == bv.Bytes().Len() - 1) {
                byte &= bv.LastByteMask();
            }

            const t_i32 bi = g_mappings[byte];

            if (bi != -1) {
                return (8 * i) + bi;
            }
        }

        return -1;
    }

    t_i32 IndexOfFirstSetBit(const s_bit_vec_rdonly bv, const t_i32 from) {
        return IndexOfFirstSetBitHelper(bv, from, 0);
    }

    t_i32 IndexOfFirstUnsetBit(const s_bit_vec_rdonly bv, const t_i32 from) {
        return IndexOfFirstSetBitHelper(bv, from, 0xFF);
    }

    t_i32 CountSetBits(const s_bit_vec_rdonly bv) {
        // Map of each possible byte to the number of set bits in it.
        static constexpr s_static_array<t_i32, 256> g_mappings = {{
            0, // 0000 0000
            1, // 0000 0001
            1, // 0000 0010
            2, // 0000 0011
            1, // 0000 0100
            2, // 0000 0101
            2, // 0000 0110
            3, // 0000 0111
            1, // 0000 1000
            2, // 0000 1001
            2, // 0000 1010
            3, // 0000 1011
            2, // 0000 1100
            3, // 0000 1101
            3, // 0000 1110
            4, // 0000 1111
            1, // 0001 0000
            2, // 0001 0001
            2, // 0001 0010
            3, // 0001 0011
            2, // 0001 0100
            3, // 0001 0101
            3, // 0001 0110
            4, // 0001 0111
            2, // 0001 1000
            3, // 0001 1001
            3, // 0001 1010
            4, // 0001 1011
            3, // 0001 1100
            4, // 0001 1101
            4, // 0001 1110
            5, // 0001 1111
            1, // 0010 0000
            2, // 0010 0001
            2, // 0010 0010
            3, // 0010 0011
            2, // 0010 0100
            3, // 0010 0101
            3, // 0010 0110
            4, // 0010 0111
            2, // 0010 1000
            3, // 0010 1001
            3, // 0010 1010
            4, // 0010 1011
            3, // 0010 1100
            4, // 0010 1101
            4, // 0010 1110
            5, // 0010 1111
            2, // 0011 0000
            3, // 0011 0001
            3, // 0011 0010
            4, // 0011 0011
            3, // 0011 0100
            4, // 0011 0101
            4, // 0011 0110
            5, // 0011 0111
            3, // 0011 1000
            4, // 0011 1001
            4, // 0011 1010
            5, // 0011 1011
            4, // 0011 1100
            5, // 0011 1101
            5, // 0011 1110
            6, // 0011 1111
            1, // 0100 0000
            2, // 0100 0001
            2, // 0100 0010
            3, // 0100 0011
            2, // 0100 0100
            3, // 0100 0101
            3, // 0100 0110
            4, // 0100 0111
            2, // 0100 1000
            3, // 0100 1001
            3, // 0100 1010
            4, // 0100 1011
            3, // 0100 1100
            4, // 0100 1101
            4, // 0100 1110
            5, // 0100 1111
            2, // 0101 0000
            3, // 0101 0001
            3, // 0101 0010
            4, // 0101 0011
            3, // 0101 0100
            4, // 0101 0101
            4, // 0101 0110
            5, // 0101 0111
            3, // 0101 1000
            4, // 0101 1001
            4, // 0101 1010
            5, // 0101 1011
            4, // 0101 1100
            5, // 0101 1101
            5, // 0101 1110
            6, // 0101 1111
            2, // 0110 0000
            3, // 0110 0001
            3, // 0110 0010
            4, // 0110 0011
            3, // 0110 0100
            4, // 0110 0101
            4, // 0110 0110
            5, // 0110 0111
            3, // 0110 1000
            4, // 0110 1001
            4, // 0110 1010
            5, // 0110 1011
            4, // 0110 1100
            5, // 0110 1101
            5, // 0110 1110
            6, // 0110 1111
            3, // 0111 0000
            4, // 0111 0001
            4, // 0111 0010
            5, // 0111 0011
            4, // 0111 0100
            5, // 0111 0101
            5, // 0111 0110
            6, // 0111 0111
            4, // 0111 1000
            5, // 0111 1001
            5, // 0111 1010
            6, // 0111 1011
            5, // 0111 1100
            6, // 0111 1101
            6, // 0111 1110
            7, // 0111 1111
            1, // 1000 0000
            2, // 1000 0001
            2, // 1000 0010
            3, // 1000 0011
            2, // 1000 0100
            3, // 1000 0101
            3, // 1000 0110
            4, // 1000 0111
            2, // 1000 1000
            3, // 1000 1001
            3, // 1000 1010
            4, // 1000 1011
            3, // 1000 1100
            4, // 1000 1101
            4, // 1000 1110
            5, // 1000 1111
            2, // 1001 0000
            3, // 1001 0001
            3, // 1001 0010
            4, // 1001 0011
            3, // 1001 0100
            4, // 1001 0101
            4, // 1001 0110
            5, // 1001 0111
            3, // 1001 1000
            4, // 1001 1001
            4, // 1001 1010
            5, // 1001 1011
            4, // 1001 1100
            5, // 1001 1101
            5, // 1001 1110
            6, // 1001 1111
            2, // 1010 0000
            3, // 1010 0001
            3, // 1010 0010
            4, // 1010 0011
            3, // 1010 0100
            4, // 1010 0101
            4, // 1010 0110
            5, // 1010 0111
            3, // 1010 1000
            4, // 1010 1001
            4, // 1010 1010
            5, // 1010 1011
            4, // 1010 1100
            5, // 1010 1101
            5, // 1010 1110
            6, // 1010 1111
            3, // 1011 0000
            4, // 1011 0001
            4, // 1011 0010
            5, // 1011 0011
            4, // 1011 0100
            5, // 1011 0101
            5, // 1011 0110
            6, // 1011 0111
            4, // 1011 1000
            5, // 1011 1001
            5, // 1011 1010
            6, // 1011 1011
            5, // 1011 1100
            6, // 1011 1101
            6, // 1011 1110
            7, // 1011 1111
            2, // 1100 0000
            3, // 1100 0001
            3, // 1100 0010
            4, // 1100 0011
            3, // 1100 0100
            4, // 1100 0101
            4, // 1100 0110
            5, // 1100 0111
            3, // 1100 1000
            4, // 1100 1001
            4, // 1100 1010
            5, // 1100 1011
            4, // 1100 1100
            5, // 1100 1101
            5, // 1100 1110
            6, // 1100 1111
            3, // 1101 0000
            4, // 1101 0001
            4, // 1101 0010
            5, // 1101 0011
            4, // 1101 0100
            5, // 1101 0101
            5, // 1101 0110
            6, // 1101 0111
            4, // 1101 1000
            5, // 1101 1001
            5, // 1101 1010
            6, // 1101 1011
            5, // 1101 1100
            6, // 1101 1101
            6, // 1101 1110
            7, // 1101 1111
            3, // 1110 0000
            4, // 1110 0001
            4, // 1110 0010
            5, // 1110 0011
            4, // 1110 0100
            5, // 1110 0101
            5, // 1110 0110
            6, // 1110 0111
            4, // 1110 1000
            5, // 1110 1001
            5, // 1110 1010
            6, // 1110 1011
            5, // 1110 1100
            6, // 1110 1101
            6, // 1110 1110
            7, // 1110 1111
            4, // 1111 0000
            5, // 1111 0001
            5, // 1111 0010
            6, // 1111 0011
            5, // 1111 0100
            6, // 1111 0101
            6, // 1111 0110
            7, // 1111 0111
            5, // 1111 1000
            6, // 1111 1001
            6, // 1111 1010
            7, // 1111 1011
            6, // 1111 1100
            7, // 1111 1101
            7, // 1111 1110
            8, // 1111 1111
        }};

        t_i32 res = 0;

        if (bv.Bytes().Len() > 0) {
            for (t_i32 i = 0; i < bv.Bytes().Len() - 1; i++) {
                res += g_mappings[bv.Bytes()[i]];
            }

            res += g_mappings[bv.Bytes()[bv.Bytes().Len() - 1] & bv.LastByteMask()];
        }

        return res;
    }
}
