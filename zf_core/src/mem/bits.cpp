#include <zc/mem/bits.h>

namespace zf {
    int IndexOfFirstSetBit(const c_array<const t_u8> bytes, const t_u8 xor = 0) {
        static constexpr s_static_array<int, 256> fs_mappings = {
            {
                -1, // 0000 0000
                 0, // 0000 0001
                 1, // 0000 0010
                 0, // 0000 0011
                 2, // 0000 0100
                 0, // 0000 0101
                 1, // 0000 0110
                 0, // 0000 0111
                 3, // 0000 1000
                 0, // 0000 1001
                 1, // 0000 1010
                 0, // 0000 1011
                 2, // 0000 1100
                 0, // 0000 1101
                 1, // 0000 1110
                 0, // 0000 1111
                 4, // 0001 0000
                 0, // 0001 0001
                 1, // 0001 0010
                 0, // 0001 0011
                 2, // 0001 0100
                 0, // 0001 0101
                 1, // 0001 0110
                 0, // 0001 0111
                 3, // 0001 1000
                 0, // 0001 1001
                 1, // 0001 1010
                 0, // 0001 1011
                 2, // 0001 1100
                 0, // 0001 1101
                 1, // 0001 1110
                 0, // 0001 1111
                 5, // 0010 0000
                 0, // 0010 0001
                 1, // 0010 0010
                 0, // 0010 0011
                 2, // 0010 0100
                 0, // 0010 0101
                 1, // 0010 0110
                 0, // 0010 0111
                 3, // 0010 1000
                 0, // 0010 1001
                 1, // 0010 1010
                 0, // 0010 1011
                 2, // 0010 1100
                 0, // 0010 1101
                 1, // 0010 1110
                 0, // 0010 1111
                 4, // 0011 0000
                 0, // 0011 0001
                 1, // 0011 0010
                 0, // 0011 0011
                 2, // 0011 0100
                 0, // 0011 0101
                 1, // 0011 0110
                 0, // 0011 0111
                 3, // 0011 1000
                 0, // 0011 1001
                 1, // 0011 1010
                 0, // 0011 1011
                 2, // 0011 1100
                 0, // 0011 1101
                 1, // 0011 1110
                 0, // 0011 1111
                 6, // 0100 0000
                 0, // 0100 0001
                 1, // 0100 0010
                 0, // 0100 0011
                 2, // 0100 0100
                 0, // 0100 0101
                 1, // 0100 0110
                 0, // 0100 0111
                 3, // 0100 1000
                 0, // 0100 1001
                 1, // 0100 1010
                 0, // 0100 1011
                 2, // 0100 1100
                 0, // 0100 1101
                 1, // 0100 1110
                 0, // 0100 1111
                 4, // 0101 0000
                 0, // 0101 0001
                 1, // 0101 0010
                 0, // 0101 0011
                 2, // 0101 0100
                 0, // 0101 0101
                 1, // 0101 0110
                 0, // 0101 0111
                 3, // 0101 1000
                 0, // 0101 1001
                 1, // 0101 1010
                 0, // 0101 1011
                 2, // 0101 1100
                 0, // 0101 1101
                 1, // 0101 1110
                 0, // 0101 1111
                 5, // 0110 0000
                 0, // 0110 0001
                 1, // 0110 0010
                 0, // 0110 0011
                 2, // 0110 0100
                 0, // 0110 0101
                 1, // 0110 0110
                 0, // 0110 0111
                 3, // 0110 1000
                 0, // 0110 1001
                 1, // 0110 1010
                 0, // 0110 1011
                 2, // 0110 1100
                 0, // 0110 1101
                 1, // 0110 1110
                 0, // 0110 1111
                 4, // 0111 0000
                 0, // 0111 0001
                 1, // 0111 0010
                 0, // 0111 0011
                 2, // 0111 0100
                 0, // 0111 0101
                 1, // 0111 0110
                 0, // 0111 0111
                 3, // 0111 1000
                 0, // 0111 1001
                 1, // 0111 1010
                 0, // 0111 1011
                 2, // 0111 1100
                 0, // 0111 1101
                 1, // 0111 1110
                 0, // 0111 1111
                 7, // 1000 0000
                 0, // 1000 0001
                 1, // 1000 0010
                 0, // 1000 0011
                 2, // 1000 0100
                 0, // 1000 0101
                 1, // 1000 0110
                 0, // 1000 0111
                 3, // 1000 1000
                 0, // 1000 1001
                 1, // 1000 1010
                 0, // 1000 1011
                 2, // 1000 1100
                 0, // 1000 1101
                 1, // 1000 1110
                 0, // 1000 1111
                 4, // 1001 0000
                 0, // 1001 0001
                 1, // 1001 0010
                 0, // 1001 0011
                 2, // 1001 0100
                 0, // 1001 0101
                 1, // 1001 0110
                 0, // 1001 0111
                 3, // 1001 1000
                 0, // 1001 1001
                 1, // 1001 1010
                 0, // 1001 1011
                 2, // 1001 1100
                 0, // 1001 1101
                 1, // 1001 1110
                 0, // 1001 1111
                 5, // 1010 0000
                 0, // 1010 0001
                 1, // 1010 0010
                 0, // 1010 0011
                 2, // 1010 0100
                 0, // 1010 0101
                 1, // 1010 0110
                 0, // 1010 0111
                 3, // 1010 1000
                 0, // 1010 1001
                 1, // 1010 1010
                 0, // 1010 1011
                 2, // 1010 1100
                 0, // 1010 1101
                 1, // 1010 1110
                 0, // 1010 1111
                 4, // 1011 0000
                 0, // 1011 0001
                 1, // 1011 0010
                 0, // 1011 0011
                 2, // 1011 0100
                 0, // 1011 0101
                 1, // 1011 0110
                 0, // 1011 0111
                 3, // 1011 1000
                 0, // 1011 1001
                 1, // 1011 1010
                 0, // 1011 1011
                 2, // 1011 1100
                 0, // 1011 1101
                 1, // 1011 1110
                 0, // 1011 1111
                 6, // 1100 0000
                 0, // 1100 0001
                 1, // 1100 0010
                 0, // 1100 0011
                 2, // 1100 0100
                 0, // 1100 0101
                 1, // 1100 0110
                 0, // 1100 0111
                 3, // 1100 1000
                 0, // 1100 1001
                 1, // 1100 1010
                 0, // 1100 1011
                 2, // 1100 1100
                 0, // 1100 1101
                 1, // 1100 1110
                 0, // 1100 1111
                 4, // 1101 0000
                 0, // 1101 0001
                 1, // 1101 0010
                 0, // 1101 0011
                 2, // 1101 0100
                 0, // 1101 0101
                 1, // 1101 0110
                 0, // 1101 0111
                 3, // 1101 1000
                 0, // 1101 1001
                 1, // 1101 1010
                 0, // 1101 1011
                 2, // 1101 1100
                 0, // 1101 1101
                 1, // 1101 1110
                 0, // 1101 1111
                 5, // 1110 0000
                 0, // 1110 0001
                 1, // 1110 0010
                 0, // 1110 0011
                 2, // 1110 0100
                 0, // 1110 0101
                 1, // 1110 0110
                 0, // 1110 0111
                 3, // 1110 1000
                 0, // 1110 1001
                 1, // 1110 1010
                 0, // 1110 1011
                 2, // 1110 1100
                 0, // 1110 1101
                 1, // 1110 1110
                 0, // 1110 1111
                 4, // 1111 0000
                 0, // 1111 0001
                 1, // 1111 0010
                 0, // 1111 0011
                 2, // 1111 0100
                 0, // 1111 0101
                 1, // 1111 0110
                 0, // 1111 0111
                 3, // 1111 1000
                 0, // 1111 1001
                 1, // 1111 1010
                 0, // 1111 1011
                 2, // 1111 1100
                 0, // 1111 1101
                 1, // 1111 1110
                 0  // 1111 1111
            }
        };

        for (int i = 0; i < bytes.Len(); i++) {
            const int bi = fs_mappings[bytes[i] ^ xor];

            if (bi != -1) {
                return bi;
            }
        }

        return -1;
    }

    static t_u8 LeftShiftOnByte(t_u8& byte, const size_t amount, const t_u8 carry = 0, const t_u8 bit_cnt) {
        assert(amount <= 8);
        assert(carry < (1 << amount));
        assert(bit_cnt <= 8);
        const t_u8 byte_old = byte;
        byte <<= amount;
        byte |= carry;
        return (byte_old >> (bit_cnt - amount)) & ((1 << amount) - 1);
    }

    static t_u8 RightShiftOnByte(t_u8& byte, const size_t amount, const t_u8 carry = 0, const t_u8 bit_cnt) {
        assert(amount <= 8);
        assert(carry < (1 << amount));
        assert(bit_cnt <= 8);
        const t_u8 byte_old = byte;
        byte <<= amount;
        byte |= carry >> (8 - bit_cnt);
        return (byte_old & ((1 << amount) - 1)) << ;
    }

    void ShiftLeft(const c_array<t_u8> bytes, size_t amount, const bool rot = false) {
        while (amount > 0) {
            const size_t amount_to_shift_by = Min(amount, 8);

            t_u8 carry = 0;

            for (int i = 0; i < bytes.Len(); i++) {
                const t_u8 carry_to_apply = carry;
                carry = bytes[i] >> (8 - amount_to_shift_by);
                bytes[i] <<= amount_to_shift_by;
                bytes[i] |= carry_to_apply;
            }

            if (rot && bytes.Len() > 0) {
                bytes[0] |= carry;
            }

            amount -= amount_to_shift_by;
        }
    }

    void ShiftRight(const c_array<t_u8> bytes, size_t amount, const bool rot = false) {
        while (amount > 0) {
            const size_t amount_to_shift_by = Min(amount, 8);

            t_u8 carry = 0;

            for (int i = bytes.Len() - 1; i >= 0; i--) {
                const t_u8 carry_to_apply = carry;
                carry = bytes[i] << (8 - amount_to_shift_by);
                bytes[i] >>= amount_to_shift_by;
                bytes[i] |= carry_to_apply;
            }

            if (rot && bytes.Len() > 0) {
                bytes[bytes.Len() - 1] |= carry;
            }

            amount -= amount_to_shift_by;
        }
    }

    void And(const c_array<t_u8> bytes, const c_array<const t_u8> mask) {
        assert(bytes.Len() == mask.Len());

        for (int i = 0; i < bytes.Len(); i++) {
            bytes[i] &= mask[i];
        }
    }

    void Or(const c_array<t_u8> bytes, const c_array<const t_u8> mask) {
        assert(bytes.Len() == mask.Len());

        for (int i = 0; i < bytes.Len(); i++) {
            bytes[i] |= mask[i];
        }
    }

    void Xor(const c_array<t_u8> bytes, const c_array<const t_u8> mask) {
        assert(bytes.Len() == mask.Len());

        for (int i = 0; i < bytes.Len(); i++) {
            bytes[i] ^= mask[i];
        }
    }
}
